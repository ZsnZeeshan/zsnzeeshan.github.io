<!-- Disable Google Analytics w/o consent -->

<!-- {% if site.google_analytics %}
  <script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
            m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
        })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
    ga('create', '{{ site.google_analytics }}', 'auto');
    ga('send', 'pageview');
  </script>
{% endif %} -->

<!-- NoCookieAnalytics (always loads, cookieless, GDPR-safe) -->
<script async defer src="https://nocookieanalytics.com/latest.js"></script>

<script>
  window.nca_queue = window.nca_queue || [];
  function nca_track_safe() {
    window.nca_queue.push(arguments);
  }
</script>

<script>
  // Track the initial page view for all visitors
  nca_track_safe('page_view');
  // Track actual page path
  nca_track_safe('page_visited_' + window.location.pathname.replace(/\//g, '_'));

  // Track referrer if available
  if (document.referrer) {
    nca_track_safe('referrer_' + btoa(document.referrer));
  }

  // track button clicks
  document.querySelectorAll('.track-click').forEach(btn => {
    btn.addEventListener('click', () => {
      const eventName = btn.dataset.event || 'button_click';
      nca_track_safe(eventName);
    });
  });

  // Track session time (example)
    setTimeout(() => {
      nca_track_safe('time_on_page', 30); // user stayed 30 seconds
    }, 30000);

  // Helper function for custom NoCookieAnalytics events
  function trackNCAEvent(name, value = 1) {
    if (typeof nca_track === 'function') nca_track_safe(name, value);
  }

  // Optional: helper function to track GA events if consent given
  function trackGAEvent(name, value = 1) {
    if (window.gtag && localStorage.getItem('ga_consent') === 'granted') {
      gtag('event', name, { value: value });
    }
  }
</script>

<!-- Google Analytics with explicit consent -->
<div id="cookie-consent" style="position:fixed;bottom:0;left:0;right:0;
            background:#111;color:#fff;padding:12px;
            font-size:14px;z-index:9999;display:none;text-align:center;">
  This site uses Google Analytics to monitor traffic.
  <a href="/privacy.html" style="color:#9cf; display:inline-block; margin-left:8px;">Privacy policy</a>
  <button id="accept-cookies" style="margin-left:12px; padding:4px 8px;">Accept</button>
</div>

<script>
  (function () {
    const consentKey = "ga_consent";
    const banner = document.getElementById("cookie-consent");
    const consent = localStorage.getItem(consentKey);

    // Show banner if no consent yet
    if (!consent) banner.style.display = "block";

    // Handle Accept button
    document.getElementById("accept-cookies").onclick = function () {
      localStorage.setItem(consentKey, "granted");
      banner.style.display = "none";
      loadGA();
    };

    // Load GA if consent was already given
    if (consent === "granted") loadGA();

    function loadGA() {
      if (window.gaLoaded) return; // Prevent double-loading
      window.gaLoaded = true;

      window.dataLayer = window.dataLayer || [];
      window.gtag = function () { dataLayer.push(arguments); }
      gtag('consent', 'default', { 'analytics_storage': 'denied' });

      // Load GA script
      const s = document.createElement("script");
      s.src = "https://www.googletagmanager.com/gtag/js?id=G-3T5JF88VB0";
      s.async = true;
      document.head.appendChild(s);

      gtag('js', new Date());
      gtag('config', 'G-3T5JF88VB0', { anonymize_ip: true });
      gtag('consent', 'update', { analytics_storage: 'granted' });
    }
  })();
</script>
<!-- End Google Analytics with explicit consent + NoCookieAnalytics -->